<!DOCTYPE html>

<html>
<head>
  <title>dycco.py</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <style type="text/css" media="screen">
    /*--------------------- Layout and Typography ----------------------------*/
    body {
      font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
      font-size: 15px;
      line-height: 22px;
      color: #252519;
      margin: 0; padding: 0;
    }
    a {
      color: #261a3b;
    }
      a:visited {
        color: #261a3b;
      }
    p {
      margin: 0 0 15px 0;
    }
    h1, h2, h3, h4, h5, h6 {
      margin: 0px 0 15px 0;
    }
      h1 {
        margin-top: 40px;
      }
    #container {
      position: relative;
    }
    #background {
      position: fixed;
      top: 0; left: 525px; right: 0; bottom: 0;
      background: #f5f5ff;
      border-left: 1px solid #e5e5ee;
      z-index: -1;
    }
    #jump_to, #jump_page {
      background: white;
      -webkit-box-shadow: 0 0 25px #777; -moz-box-shadow: 0 0 25px #777;
      -webkit-border-bottom-left-radius: 5px; -moz-border-radius-bottomleft: 5px;
      font: 10px Arial;
      text-transform: uppercase;
      cursor: pointer;
      text-align: right;
    }
    #jump_to, #jump_wrapper {
      position: fixed;
      right: 0; top: 0;
      padding: 5px 10px;
    }
      #jump_wrapper {
        padding: 0;
        display: none;
      }
        #jump_to:hover #jump_wrapper {
          display: block;
        }
        #jump_page {
          padding: 5px 0 3px;
          margin: 0 0 25px 25px;
        }
          #jump_page .source {
            display: block;
            padding: 5px 10px;
            text-decoration: none;
            border-top: 1px solid #eee;
          }
            #jump_page .source:hover {
              background: #f5f5ff;
            }
            #jump_page .source:first-child {
            }
    table td {
      border: 0;
      outline: 0;
    }
      td.docs, th.docs {
        max-width: 450px;
        min-width: 450px;
        min-height: 5px;
        padding: 10px 25px 1px 50px;
        overflow-x: hidden;
        vertical-align: top;
        text-align: left;
      }
        .docs pre {
          margin: 15px 0 15px;
          padding-left: 15px;
        }
        .docs p tt, .docs p code {
          background: #f8f8ff;
          border: 1px solid #dedede;
          font-size: 12px;
          padding: 0 0.2em;
        }
        .pilwrap {
          position: relative;
        }
          .pilcrow {
            font: 12px Arial;
            text-decoration: none;
            color: #454545;
            position: absolute;
            top: 3px; left: -20px;
            padding: 1px 2px;
            opacity: 0;
            -webkit-transition: opacity 0.2s linear;
          }
            td.docs:hover .pilcrow {
              opacity: 1;
            }
      td.code, th.code {
        padding: 14px 15px 16px 25px;
        width: 100%;
        vertical-align: top;
        background: #f5f5ff;
        border-left: 1px solid #e5e5ee;
      }
        pre, tt, code {
          font-size: 12px; line-height: 18px;
          font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
          margin: 0; padding: 0;
        }

    /*---------------------- Syntax Highlighting -----------------------------*/
    td.linenos { background-color: #f0f0f0; padding-right: 10px; }
    span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
    body .hll { background-color: #ffffcc }
    body .c { color: #408080; font-style: italic }  /* Comment */
    body .err { border: 1px solid #FF0000 }         /* Error */
    body .k { color: #954121 }                      /* Keyword */
    body .o { color: #666666 }                      /* Operator */
    body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
    body .cp { color: #BC7A00 }                     /* Comment.Preproc */
    body .c1 { color: #408080; font-style: italic } /* Comment.Single */
    body .cs { color: #408080; font-style: italic } /* Comment.Special */
    body .gd { color: #A00000 }                     /* Generic.Deleted */
    body .ge { font-style: italic }                 /* Generic.Emph */
    body .gr { color: #FF0000 }                     /* Generic.Error */
    body .gh { color: #000080; font-weight: bold }  /* Generic.Heading */
    body .gi { color: #00A000 }                     /* Generic.Inserted */
    body .go { color: #808080 }                     /* Generic.Output */
    body .gp { color: #000080; font-weight: bold }  /* Generic.Prompt */
    body .gs { font-weight: bold }                  /* Generic.Strong */
    body .gu { color: #800080; font-weight: bold }  /* Generic.Subheading */
    body .gt { color: #0040D0 }                     /* Generic.Traceback */
    body .kc { color: #954121 }                     /* Keyword.Constant */
    body .kd { color: #954121; font-weight: bold }  /* Keyword.Declaration */
    body .kn { color: #954121; font-weight: bold }  /* Keyword.Namespace */
    body .kp { color: #954121 }                     /* Keyword.Pseudo */
    body .kr { color: #954121; font-weight: bold }  /* Keyword.Reserved */
    body .kt { color: #B00040 }                     /* Keyword.Type */
    body .m { color: #666666 }                      /* Literal.Number */
    body .s { color: #219161 }                      /* Literal.String */
    body .na { color: #7D9029 }                     /* Name.Attribute */
    body .nb { color: #954121 }                     /* Name.Builtin */
    body .nc { color: #0000FF; font-weight: bold }  /* Name.Class */
    body .no { color: #880000 }                     /* Name.Constant */
    body .nd { color: #AA22FF }                     /* Name.Decorator */
    body .ni { color: #999999; font-weight: bold }  /* Name.Entity */
    body .ne { color: #D2413A; font-weight: bold }  /* Name.Exception */
    body .nf { color: #0000FF }                     /* Name.Function */
    body .nl { color: #A0A000 }                     /* Name.Label */
    body .nn { color: #0000FF; font-weight: bold }  /* Name.Namespace */
    body .nt { color: #954121; font-weight: bold }  /* Name.Tag */
    body .nv { color: #19469D }                     /* Name.Variable */
    body .ow { color: #AA22FF; font-weight: bold }  /* Operator.Word */
    body .w { color: #bbbbbb }                      /* Text.Whitespace */
    body .mf { color: #666666 }                     /* Literal.Number.Float */
    body .mh { color: #666666 }                     /* Literal.Number.Hex */
    body .mi { color: #666666 }                     /* Literal.Number.Integer */
    body .mo { color: #666666 }                     /* Literal.Number.Oct */
    body .sb { color: #219161 }                     /* Literal.String.Backtick */
    body .sc { color: #219161 }                     /* Literal.String.Char */
    body .sd { color: #219161; font-style: italic } /* Literal.String.Doc */
    body .s2 { color: #219161 }                     /* Literal.String.Double */
    body .se { color: #BB6622; font-weight: bold }  /* Literal.String.Escape */
    body .sh { color: #219161 }                     /* Literal.String.Heredoc */
    body .si { color: #BB6688; font-weight: bold }  /* Literal.String.Interpol */
    body .sx { color: #954121 }                     /* Literal.String.Other */
    body .sr { color: #BB6688 }                     /* Literal.String.Regex */
    body .s1 { color: #219161 }                     /* Literal.String.Single */
    body .ss { color: #19469D }                     /* Literal.String.Symbol */
    body .bp { color: #954121 }                     /* Name.Builtin.Pseudo */
    body .vc { color: #19469D }                     /* Name.Variable.Class */
    body .vg { color: #19469D }                     /* Name.Variable.Global */
    body .vi { color: #19469D }                     /* Name.Variable.Instance */
    body .il { color: #666666 }                     /* Literal.Number.Integer.Long */
  </style>
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
          </div>
        </div>
      </div>
    
    <table cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th class="docs">
            <h1>dycco.py</h1>
          </th>
          <th class="code">
          </th>
        </tr>
      </thead>
      <tbody>
        <tr id="section-">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-">&#182;</a>
              </div>
              
            </td>
            <td class="code">
              <div class="highlight"><pre>
</pre></div>

            </td>
          </tr><tr id="section-2">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><strong>Dycco</strong> is another Python port of <a href="http://jashkenas.github.com/docco/">Docco</a>, the quick-and-dirty,
hundred-line-long, literate-programming-style documentation generator.</p>
<p>Dycco reads Python source files and produces annotated source documentation in
HTML format. Comments and docstrings are formatted with <a href="http://daringfireball.net/projects/markdown/">Markdown</a>
and presented as annotations alongside the source code, which is
syntax-highlighted by <a href="http://pygments.org/">Pygments</a>. This page is the result of running
Dycco against its <a href="https://github.com/mccutchen/dycco">own source file</a>.</p>
<p>Currently, there is no setup for Dycco, so you'll have to fetch its <a href="https://github.com/mccutchen/dycco">source
code</a> and the prerequisites yourself. Dycco can then be run like so</p>
<pre><code>dycco.py *.py
</code></pre>
<p>to generate documentation for each Python file in the current directory. The
documentation is output into a <code>docs/</code> directory in the current directory.</p>
<p>Dycco differs from Nick Fitzgerald's <a href="http://fitzgen.github.com/pycco/">Pycco</a>, the first Python port of
<a href="http://jashkenas.github.com/docco/">Docco</a> in that it only knows how to generate documenation on Python
source code and it uses that specialization to more accurately parse
documentation. It does so using a two-pass parsing stage, first walking the
<em>Abstract Syntax Tree</em> of the code to gather up docstrings, then examining the
code line-by-line to extract comments.</p>
<p><a href="http://jashkenas.github.com/docco/">Docco</a>'s gorgeous HTML and CSS are taken verbatim. Like
<a href="http://fitzgen.github.com/pycco/">Pycco</a>, Dycco uses <a href="http://mustache.github.com/">Mustache</a> templates rendered by
<a href="https://github.com/defunkt/pystache">Pystache</a>. The first version of Dycco's templates and CSS were
taken straight from <a href="http://fitzgen.github.com/pycco/">Pycco</a>, then updated to match the latest changes
to <a href="http://jashkenas.github.com/docco/">Docco</a>'s output.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>
</pre></div>

            </td>
          </tr><tr id="section-45">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h2>Prerequisites</h2>
<p>Dycco requires the <code>markdown</code>, <code>pystache</code> and <code>pygments</code> modules to be
 installed.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="kn">import</span> <span class="nn">markdown</span>
<span class="kn">import</span> <span class="nn">pystache</span>
<span class="kn">from</span> <span class="nn">pygments</span> <span class="kn">import</span> <span class="n">highlight</span>
<span class="kn">from</span> <span class="nn">pygments.lexers</span> <span class="kn">import</span> <span class="n">get_lexer_by_name</span>
<span class="kn">from</span> <span class="nn">pygments.formatters</span> <span class="kn">import</span> <span class="n">HtmlFormatter</span>

<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>


<span class="n">DEFAULT_OUTPUT_DIR</span> <span class="o">=</span> <span class="s">&#39;docs&#39;</span>
<span class="n">COMMENT_PATTERN</span> <span class="o">=</span> <span class="s">&#39;^\s*#&#39;</span>
</pre></div>

            </td>
          </tr><tr id="section-63">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Generates documentation for the Python files at the given <code>paths</code> by
parsing each file into pairs of documentation and source code and
rendering those pairs into an HTML file. The <code>paths</code> param can be a <code>list</code>
of paths or a single <code>str</code> path.</p>
<h2>Main Documentation Generation Functions</h2>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">def</span> <span class="nf">document</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">DEFAULT_OUTPUT_DIR</span><span class="p">):</span>
</pre></div>

            </td>
          </tr><tr id="section-72">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>If we get a single path, stick it in a list so we can still pretend
 we're operating on multiple paths.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>
</pre></div>

            </td>
          </tr><tr id="section-76">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Make sure the directory exists</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
</pre></div>

            </td>
          </tr><tr id="section-81">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Build a list of (path, filename, output_path) tuples, which will be used
 to build the links to other source code docs in the templates</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="n">filenames</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">paths</span><span class="p">)</span>
    <span class="n">output_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">make_output_path</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">]</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">output_paths</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">output_path</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sections</span><span class="p">,</span> <span class="n">sources</span><span class="p">)</span>
</pre></div>

            </td>
          </tr><tr id="section-90">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Create/overwrite the documentation at the given path</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
</pre></div>

            </td>
          </tr><tr id="section-93">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Parse the source code at the given path, in two passes. The first pass
walks the Abstract Syntax Tree of the code, gathering up any
docstrings. The second pass processes the code line by line, grouping the
code into sections based on docstrings and comments.</p>
<p>The data structure returned is a special <code>dict</code> whose keys are the line
numbers where sections start, which map to <code>dict</code>s containing the docs and
code associated with those sections. The docs and code are stored as
lists, which will be joined in post processing.</p>
<p>It will look a little like this:</p>
<pre><code>{ 1: { 'docs': ['...', '...'],
       'code': ['...', '...'] },
  9: { 'docs': ['...', '...'],
       'code': ['...', '...'] } }
</code></pre>
<p>The docs for each section can come from docstrings (the first pass) or
from comments (the second pass). The line numbers start at zero, for
simplicity's sake.</p>
<p>Any module-level documentation is stored in the section under the <code>None</code>
key, and will come before any other sections in the output.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</pre></div>

            </td>
          </tr><tr id="section-119">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>A callable that will generate the datastructure used to store each
section. Used as the argument to <code>defaultdict</code> below.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">section</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span> <span class="s">&#39;docs&#39;</span><span class="p">:</span> <span class="p">[],</span>
                 <span class="s">&#39;code&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="p">}</span>
</pre></div>

            </td>
          </tr><tr id="section-127">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>Read the whole source file into memory.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>

            </td>
          </tr><tr id="section-132">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>The basic <code>sections</code> datastructure we'll use to keep track of code and
 documentation.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="n">sections</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
</pre></div>

            </td>
          </tr><tr id="section-137">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>First pass: Parse all of the docstrings and get a list of lines we
 should skip when parsing the rest of the code. Modifies <code>sections</code> in
 place.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="n">skip_lines</span> <span class="o">=</span> <span class="n">parse_docstrings</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sections</span><span class="p">)</span>
</pre></div>

            </td>
          </tr><tr id="section-141">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Second pass: Parse the rest of the code, adding code and comments to the
 appropriate sections. Modifies <code>sections</code> in place.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="n">parse_code</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sections</span><span class="p">,</span> <span class="n">skip_lines</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sections</span>
</pre></div>

            </td>
          </tr><tr id="section-145">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>Parse the given <code>src</code> to find any docstrings, add them to the
appropriate place in <code>sections</code>, and return a <code>set</code> of line numbers where
the docstrings are. <strong>Note:</strong> Modifies <code>sections</code> in place.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">def</span> <span class="nf">parse_docstrings</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sections</span><span class="p">):</span>
</pre></div>

            </td>
          </tr><tr id="section-151">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>Find any docstrings in the source code by walking its AST.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="n">visitor</span> <span class="o">=</span> <span class="n">DocStringVisitor</span><span class="p">()</span>
    <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
</pre></div>

            </td>
          </tr><tr id="section-156">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>Add all of the docstrings we've found to the appropriate places in the
 <code>sections</code> datastructure. The corresponding code will be added later.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">target_line</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">visitor</span><span class="o">.</span><span class="n">docstrings</span><span class="p">:</span>
        <span class="n">sections</span><span class="p">[</span><span class="n">target_line</span><span class="p">][</span><span class="s">&#39;docs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
</pre></div>

            </td>
          </tr><tr id="section-161">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>Build a set of the line numbers where we found docstrings, so we know to
 skip them in the second pass.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="n">skip_lines</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">start_line</span><span class="p">,</span> <span class="n">end_line</span> <span class="ow">in</span> <span class="n">visitor</span><span class="o">.</span><span class="n">docstrings</span><span class="p">:</span>
        <span class="n">skip_lines</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="n">start_line</span><span class="p">,</span> <span class="n">end_line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">skip_lines</span>
</pre></div>

            </td>
          </tr><tr id="section-167">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>Parse the given <code>src</code> line by line to gather source code and comments
into the appropriate places in <code>sections</code>. Any line numbers in
<code>skip_lines</code> are skipped. <strong>Note:</strong> Modifies <code>sections</code> in place.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">def</span> <span class="nf">parse_code</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sections</span><span class="p">,</span> <span class="n">skip_lines</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
</pre></div>

            </td>
          </tr><tr id="section-174">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>Iterate through each line of source code to gather up comments and code
 listings and add them to the sections structure.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="n">current_comment</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">current_section</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
</pre></div>

            </td>
          </tr><tr id="section-178">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>Skip any lines that were in docstrings</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">skip_lines</span> <span class="ow">or</span> <span class="n">should_filter</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
            <span class="k">continue</span>
</pre></div>

            </td>
          </tr><tr id="section-185">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>Are we looking at a comment? If so, and we do not have a current
 comment block, we're starting a new section. If we do have a current
 comment block, we just add this comment to it (e.g. multi-line
 comments).</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">COMMENT_PATTERN</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">COMMENT_PATTERN</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_comment</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">current_comment</span> <span class="o">=</span> <span class="n">comment</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_comment</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">comment</span>
</pre></div>

            </td>
          </tr><tr id="section-195">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>Otherwise, we're looking at a line of code and we need to add it to
 the appropriate section, along with any preceding comments.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="k">else</span><span class="p">:</span>
</pre></div>

            </td>
          </tr><tr id="section-198">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>If we have a current comment, that means we're starting a new
 section with this line of code.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="k">if</span> <span class="n">current_comment</span><span class="p">:</span>
                <span class="n">sections</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;docs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_comment</span><span class="p">)</span>
                <span class="n">current_comment</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="n">i</span>
</pre></div>

            </td>
          </tr><tr id="section-207">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p>Otherwise, if we don't have a current section, we're at our
 first bit of code (aside from any module-level docstrings) and
 are starting a new section. But we want to skip any empty
 leading blank lines.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="k">elif</span> <span class="n">current_section</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="n">i</span>
</pre></div>

            </td>
          </tr><tr id="section-214">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>If the current line is already in the <code>sections</code> datastructure,
 it is (probably) associated with a docstring from the first
 pass, and we should add it to that section instead of whatever
 current section we have.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
                <span class="n">current_section</span> <span class="o">=</span> <span class="n">i</span>
</pre></div>

            </td>
          </tr><tr id="section-219">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>Finally, append the current line of code to the current
 section's code block</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="n">sections</span><span class="p">[</span><span class="n">current_section</span><span class="p">][</span><span class="s">&#39;code&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>

            </td>
          </tr><tr id="section-221">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>Test the given line to see if it should be included. Excludes shebang
lines, for now.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">def</span> <span class="nf">should_filter</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#!&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</pre></div>

            </td>
          </tr><tr id="section-229">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>Renders the given sections, which should be the result of calling
<code>parse</code> on a source code file, into HTML.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">sections</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
</pre></div>

            </td>
          </tr><tr id="section-236">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>Transform the <code>sections</code> <code>dict</code> we were given into a format suitable for
 our Mustache template. Along the way, preprocess each block of
 documentation and code, via Markdown and Pygments.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="n">sections</span> <span class="o">=</span> <span class="p">[{</span>
        <span class="s">&#39;num&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span>
        <span class="s">&#39;docs_html&#39;</span><span class="p">:</span> <span class="n">preprocess_docs</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s">&#39;docs&#39;</span><span class="p">]),</span>
        <span class="s">&#39;code_html&#39;</span><span class="p">:</span> <span class="n">preprocess_code</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s">&#39;code&#39;</span><span class="p">])</span>
    <span class="p">}</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sections</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="s">&#39;sections&#39;</span><span class="p">:</span> <span class="n">sections</span>
        <span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;template.html&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pystache</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">context</span><span class="p">)</span>
</pre></div>

            </td>
          </tr><tr id="section-249">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>Preprocess the given <code>docs</code>, which should be a <code>list</code> of strings, by
joining them together and running them through Markdown.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">def</span> <span class="nf">preprocess_docs</span><span class="p">(</span><span class="n">docs</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">markdown</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docs</span><span class="p">))</span>
</pre></div>

            </td>
          </tr><tr id="section-256">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p>Preprocess the given code, which should be a <code>list</code> of strings, by
joining them together and running them through the Pygments syntax
highlighter.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">def</span> <span class="nf">preprocess_code</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="n">lexer</span> <span class="o">=</span> <span class="n">get_lexer_by_name</span><span class="p">(</span><span class="s">&quot;python&quot;</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">HtmlFormatter</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">highlight</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">code</span><span class="p">),</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">formatter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

            </td>
          </tr><tr id="section-267">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p>Creates an appropriate output path for the given source file and output
directory. The output file name will be the name of the source file
without its extension.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">def</span> <span class="nf">make_output_path</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.html&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</pre></div>

            </td>
          </tr><tr id="section-276">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <p>A <code>NodeVisitor</code> subclass that walks an Abstract Syntax Tree and gathers
up and notes the positions of any docstrings it finds.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre><span class="k">class</span> <span class="nc">DocStringVisitor</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>

            </td>
          </tr><tr id="section-285">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-285">&#182;</a>
              </div>
              <p>Docstrings will be tracked as a list of 4-tuples that contain the
 docstring, the line of the code to which it applies, its starting
 line and its ending line.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">docstrings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_doc</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>

            </td>
          </tr><tr id="section-289">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-289">&#182;</a>
              </div>
              <p>A method to be called when visiting any node that might have an
associated docstring (ie, module, function and class nodes). This uses
<code>ast.get_docstring</code> to grab and sanitize the docstring, and notes
which node we're currently looking at.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_visit_docstring_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="n">node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_doc</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">get_docstring</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DocStringVisitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>

            </td>
          </tr><tr id="section-300">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-300">&#182;</a>
              </div>
              <p>Use the <code>_visit_docstring_node</code> method when visiting all of these nodes.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="n">visit_Module</span> <span class="o">=</span> <span class="n">_visit_docstring_node</span>
    <span class="n">visit_FunctionDef</span> <span class="o">=</span> <span class="n">_visit_docstring_node</span>
    <span class="n">visit_ClassDef</span> <span class="o">=</span> <span class="n">_visit_docstring_node</span>
</pre></div>

            </td>
          </tr><tr id="section-304">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-304">&#182;</a>
              </div>
              <p>We need to actually visit the nodes representing the docstrings to
record their positions. Docstring nodes show up as <code>Expr</code> nodes whose
values are <code>Str</code> nodes.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">visit_Expr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">:</span>
</pre></div>

            </td>
          </tr><tr id="section-312">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-312">&#182;</a>
              </div>
              <p>Adjust for 0-based line counting</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="n">end_line</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>

            </td>
          </tr><tr id="section-317">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-317">&#182;</a>
              </div>
              <p>Module docstrings have to have their starting lines and targets
 calculated manually, since <code>ast.Module</code> objects have no line
 numbers.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
                <span class="n">line_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
                <span class="n">start_line</span> <span class="o">=</span> <span class="n">end_line</span> <span class="o">-</span> <span class="n">line_count</span>
                <span class="n">target_line</span> <span class="o">=</span> <span class="n">start_line</span>
</pre></div>

            </td>
          </tr><tr id="section-325">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-325">&#182;</a>
              </div>
              <p>For all other nodes, just assume that the target is on the
 previous line. <strong>TODO:</strong> This probably breaks on, e.g.,
 multiline function defs.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="o">.</span><span class="n">lineno</span>
                <span class="n">target_line</span> <span class="o">=</span> <span class="n">start_line</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>

            </td>
          </tr><tr id="section-332">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-332">&#182;</a>
              </div>
              <p>Add the sanitized version of the current docstring, its target
 and its starting and finishing line numbers to our list of
 docstrings.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">docstrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_doc</span><span class="p">,</span> <span class="n">target_line</span><span class="p">,</span> <span class="n">start_line</span><span class="p">,</span> <span class="n">end_line</span><span class="p">))</span>
</pre></div>

            </td>
          </tr><tr id="section-338">
            <td class="docs">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-338">&#182;</a>
              </div>
              <p>Reset the accounting variables even if we didn't find a docstring,
 so that we don't accidentally add "unattached" docstrings to
 whatever class/def/module happened to come before them.</p>
            </td>
            <td class="code">
              <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_node</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_doc</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DocStringVisitor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">document</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">DEFAULT_OUTPUT_DIR</span><span class="p">)</span>
</pre></div>

            </td>
          </tr>
      </tbody>
    </table>
  </div>
</body>
</html>
